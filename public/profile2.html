<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Overview</title>
  <link rel="shortcut icon" href="logo3.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const menuButton = document.querySelector('[aria-controls="mobile-menu"]');
      const mobileMenu = document.getElementById('mobile-menu');
      
      menuButton.addEventListener('click', function () {
        const expanded = menuButton.getAttribute('aria-expanded') === 'true' || false;
        menuButton.setAttribute('aria-expanded', !expanded);
        mobileMenu.classList.toggle('hidden');
      });

      const userMenuButton = document.getElementById('user-menu-button');
      const userMenu = document.getElementById('user-menu');

      userMenuButton.addEventListener('click', function () {
        userMenu.classList.toggle('hidden');
      });

      document.addEventListener('click', function(event) {
        if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
          userMenu.classList.add('hidden');
        }
      });
    });
  </script>
  <style>
    #logout{
      transform: rotate(-90deg);
    }
  </style>
</head>
<body class="bg-gray-900">
<div class="min-h-screen bg-gray-900 text-white">

  <nav class="bg-gray-800">
    <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
        <div class="relative flex h-16 items-center justify-between">
            <div class="absolute inset-y-0 left-0 flex items-center sm:hidden">
                <!-- Mobile menu button-->
                <button type="button" class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                    <svg class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-start">
                <a href="index.html" class="flex items-center hover:text-green-500">
                    <img src="logo3.png" alt="NBA Logo" class="h-8 mr-2">
                    <span class="text-xl font-semibold">NBA Guessing Game</span>
                </a>
                <div class="hidden sm:ml-6 sm:block">
                    <div class="flex space-x-4">
                        <a href="index.html" class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Unlimited</a>
                        <a href="daily.html" class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Daily</a>
                        <a href="rapid.html" class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Rapid Fire</a>
                    </div>
                </div>
            </div>
            <div class="relative ml-3 hidden sm:block">
              <div>
                <button type="button" class="flex rounded-full bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                  <span class="sr-only">Open user menu</span>
                  <img class="h-8 w-8 rounded-full" id="profilePic" alt="">
                </button>
              </div>
              <div class="hidden absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" id="user-menu" tabindex="-1">
                <a href="friends.html" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="user-menu-item-0">Friends</a>
                <a href="/logout" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="user-menu-item-2">Sign out</a>
              </div>
            </div>
        </div>
    </div>

    <!-- Mobile menu, show/hide based on menu state. -->
    <div class="hidden sm:hidden fixed bg-gray-800 z-10 w-full" id="mobile-menu">
        <div class="space-y-1 px-2 pb-3 pt-2">
            <a href="index.html" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Unlimited</a>
            <a href="daily.html" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Daily</a>
            <a href="rapid.html" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Rapid Fire</a>
            <a href="friends.html" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Friends</a>
            <a href="/logout" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Sign out</a>
        </div>
    </div>
</nav>


  <!-- Main container -->
<div class="flex flex-col md:flex-row w-full md:w-3/4 lg:w-2/3 xl:w-1/2 m-auto p-4">

  <!-- Profile Info Section -->
  <div class="flex-1 p-4 md:p-8">
    <div class="mb-4">
      <a href="index.html" class="bg-gray-800 text-white py-2 px-4 rounded hover:bg-gray-600 flex items-center">
        <svg class="mr-2" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="22.3047" height="17.9199"> 
          <g>
          <rect height="17.9199" opacity="0" width="22.3047" x="0" y="0"/>
          <path d="M9.54102 17.9102C10.2051 17.9102 10.6836 17.4219 10.6836 16.7676L10.6836 13.0371L10.9668 13.0371C14.7559 13.0371 17.1387 13.9941 18.8477 17.1875C19.1895 17.8125 19.6387 17.9102 20.0488 17.9102C20.5664 17.9102 21.0547 17.4414 21.0547 16.6016C21.0547 9.38477 17.998 4.88281 10.9668 4.88281L10.6836 4.88281L10.6836 1.19141C10.6836 0.537109 10.2051 0 9.52148 0C9.04297 0 8.7207 0.205078 8.20312 0.693359L0.498047 7.90039C0.117188 8.26172 0 8.62305 0 8.95508C0 9.27734 0.126953 9.64844 0.498047 10L8.20312 17.2754C8.67188 17.7148 9.0625 17.9102 9.54102 17.9102ZM8.98438 15.8105C8.92578 15.8105 8.86719 15.7812 8.81836 15.7227L1.85547 9.14062C1.77734 9.0625 1.74805 9.01367 1.74805 8.95508C1.74805 8.89648 1.77734 8.83789 1.85547 8.76953L8.80859 2.09961C8.85742 2.06055 8.91602 2.02148 8.97461 2.02148C9.0625 2.02148 9.11133 2.08008 9.11133 2.1582L9.11133 6.03516C9.11133 6.25977 9.21875 6.35742 9.44336 6.35742L10.752 6.35742C17.4512 6.35742 19.4727 11.0059 19.668 15.6152C19.668 15.6934 19.6387 15.7227 19.5898 15.7227C19.5508 15.7227 19.5312 15.6934 19.502 15.625C18.3496 13.1738 15.3906 11.5625 10.752 11.5625L9.44336 11.5625C9.21875 11.5625 9.11133 11.6602 9.11133 11.8848L9.11133 15.6641C9.11133 15.752 9.0625 15.8105 8.98438 15.8105Z" fill="currentColor" fill-opacity="0.85"/> 
          </g> 
      </svg>
        <span>Back to Game</span>
      </a>
    </div>

    <!-- Personal Information Card -->
    <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-md text-center">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl md:text-2xl font-bold">Personal Information</h2>
        <button class="w-6 h-6 md:w-8 md:h-8" onclick="editProfilePic()">
          <svg id="editBtn" class="hover:text-green-500" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="23.6475" height="23.3041"> 
            <g>
            <rect height="23.3041" opacity="0" width="23.6475" x="0" y="0"/>
            <path d="M15.5591 4.88935L6.08643 4.88935C5.10986 4.88935 4.56299 5.41669 4.56299 6.43232L4.56299 17.5163C4.56299 18.5319 5.10986 19.0495 6.08643 19.0495L17.2095 19.0495C18.186 19.0495 18.7231 18.5319 18.7231 17.5163L18.7231 8.12957L20.2954 6.55445L20.2954 17.5944C20.2954 19.6159 19.27 20.6218 17.229 20.6218L6.05713 20.6218C4.02588 20.6218 2.99072 19.6159 2.99072 17.5944L2.99072 6.34443C2.99072 4.33271 4.02588 3.31708 6.05713 3.31708L17.1313 3.31708Z" fill="currentColor" fill-opacity="0.85"/> 
            <path d="M9.61182 14.2936L11.5161 13.4636L20.6372 4.35224L19.2993 3.03388L10.188 12.1452L9.30908 13.9811C9.23096 14.1472 9.42627 14.3718 9.61182 14.2936ZM21.3599 3.63935L22.063 2.91669C22.395 2.56513 22.395 2.09638 22.063 1.77412L21.8384 1.53974C21.5356 1.23701 21.0571 1.27607 20.7349 1.58857L20.022 2.29169Z" fill="currentColor" fill-opacity="0.85"/> 
            </g>
          </svg>
          <svg class="hidden hover:text-green-500" id="closeBtn"  version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="23.6475" height="23.3041"> 
            <g> 
            <rect height="25.3418" opacity="0" width="17.6953" x="0" y="0"/> 
            <path d="M17.334 10.1953L17.334 19.9414C17.334 21.9531 16.3086 22.9688 14.2676 22.9688L3.06641 22.9688C1.02539 22.9688 0 21.9531 0 19.9414L0 10.1953C0 8.18359 1.02539 7.16797 3.06641 7.16797L6.00586 7.16797L6.00586 8.74023L3.08594 8.74023C2.10938 8.74023 1.57227 9.26758 1.57227 10.2832L1.57227 19.8535C1.57227 20.8691 2.10938 21.3965 3.08594 21.3965L14.2383 21.3965C15.2051 21.3965 15.7617 20.8691 15.7617 19.8535L15.7617 10.2832C15.7617 9.26758 15.2051 8.74023 14.2383 8.74023L11.3281 8.74023L11.3281 7.16797L14.2676 7.16797C16.3086 7.16797 17.334 8.18359 17.334 10.1953Z" fill="currentColor" fill-opacity="0.85"/> <path d="M8.66211 16.543C8.86719 16.543 9.0332 16.4844 9.22852 16.2891L12.5293 13.0957C12.6758 12.9492 12.7637 12.793 12.7637 12.5879C12.7637 12.1875 12.4512 11.9043 12.0508 11.9043C11.8555 11.9043 11.6602 11.9824 11.5234 12.1387L10.0391 13.7109L9.38477 14.4043L9.44336 12.9395L9.44336 2.64648C9.44336 2.23633 9.08203 1.88477 8.66211 1.88477C8.24219 1.88477 7.89062 2.23633 7.89062 2.64648L7.89062 12.9395L7.94922 14.4043L7.28516 13.7109L5.81055 12.1387C5.67383 11.9824 5.45898 11.9043 5.27344 11.9043C4.86328 11.9043 4.57031 12.1875 4.57031 12.5879C4.57031 12.793 4.64844 12.9492 4.79492 13.0957L8.0957 16.2891C8.30078 16.4844 8.4668 16.543 8.66211 16.543Z" fill="currentColor" fill-opacity="0.85"/> 
            </g> 
          </svg>
        </button>
      </div>
      <div class="profile-photo-container flex flex-col items-center justify-center mb-4">
        <input disabled type="file" id="profile_photo" name="profile_photo" class="hidden" accept="image/png, image/jpeg" onchange="loadFile(event)">
        <label id="changePic" for="profile_photo" class="w-16 h-16 md:w-20 md:h-20 border-2 border-transparent rounded-full cursor-not-allowed overflow-hidden bg-gray-700 flex justify-center items-center">
          <img id="profile_photo_preview" alt="User Avatar" class="object-cover rounded-full w-full h-full">
        </label>
      </div>
      <div class="mb-4">
        <label class="inline">Name:</label>
        <div class="user-name inline"></div>
      </div>
      <div class="mb-4">
        <label class="inline">Email:</label>
        <div class="inline email"></div>
      </div>
    </div>

    <!-- Unlimited Statistics Card -->
    <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-md mt-4 md:mt-8 text-center">
      <h2 class="text-xl md:text-2xl font-bold mb-4">Unlimited Statistics</h2>
      <div class="grid gap-4 grid-cols-2">
        <div>Games played:</div>
        <div id="games">0</div>
        <div>Longest streak:</div>
        <div id="streakL">0</div>
        <div>Current streak:</div>
        <div id="streakC">0</div>
        <div>Win percentage:</div>
        <div id="win">0%</div>
      </div>
    </div>

    <!-- Daily Statistics Card -->
    <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-md mt-4 md:mt-8 text-center">
      <h2 class="text-xl md:text-2xl font-bold mb-4">Daily Statistics</h2>
      <div class="grid gap-4 grid-cols-2">
        <div>Games played:</div>
        <div id="gamesDaily">0</div>
        <div>Longest streak:</div>
        <div id="streakLDaily">0</div>
        <div>Current streak:</div>
        <div id="streakCDaily">0</div>
        <div>Win percentage:</div>
        <div id="winDaily">0%</div>
      </div>
    </div>

    <!-- Rapid Fire Statistics Card -->
    <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-md mt-4 md:mt-8 text-center">
      <h2 class="text-xl md:text-2xl font-bold mb-4">Rapid Fire Statistics</h2>
      <div class="grid gap-4 grid-cols-2">
        <div>Games Played:</div>
        <div id="gamesPlayed">0</div>
        <div>Total score:</div>
        <div id="correctGuesses">0</div>
        <div>Best score:</div>
        <div id="maxCorrectGuesses">0</div>
        <div>Average score:</div>
        <div id="avgCorrectGuesses">0</div>
      </div>
    </div>

    <!-- Guess Distribution Chart Card -->
    <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-md mt-4 md:mt-8 text-center">
      <h2 class="text-xl md:text-2xl font-bold mb-4">Guess distribution for Unlimited</h2>
      <div class="flex justify-center">
        <canvas id="myChart" class="max-w-full"></canvas>
      </div>
    </div>
  </div>
</div>


</div>

<script>
  document.getElementById('profile_photo').addEventListener('change', function(event) {
      var input = event.target;
      var reader = new FileReader();
      reader.onload = function(){
          var dataURL = reader.result;
          var output = document.getElementById('profile_photo_preview');
          output.src = dataURL;
      };
      reader.readAsDataURL(input.files[0]);
  });
</script>

<script>

function resizeCanvas() {
  const canvas = document.getElementById('myChart');

  const heightRatio = 0.25;
  canvas.height = canvas.width * heightRatio;
}

function editProfilePic(){
  const closeBtn = document.getElementById('closeBtn');
  const editBtn = document.getElementById('editBtn');
  const profile_photo = document.getElementById('profile_photo');
  const changePic = document.getElementById('changePic');

  profile_photo.disabled = !profile_photo.disabled;
  
  editBtn.classList.toggle('hidden');
  closeBtn.classList.toggle('hidden');
  changePic.classList.toggle('cursor-not-allowed');
  changePic.classList.toggle('cursor-pointer');
  changePic.classList.toggle('border-transparent');
}



resizeCanvas();


window.addEventListener('resize', resizeCanvas);

   
  
    function createChart(labels, data) {
  const chartData = {
    labels: labels,
    datasets: [{
      axis: 'y',
      label: 'Počet výherních her',
      data: data,
      fill: false,
      backgroundColor: 'rgb(67, 148, 108)',
      borderRadius: 10 
    }]
  };

  const config = {
    type: 'bar',
    data: chartData,
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          display: false
        },
        y: {
          display: true,
          beginAtZero: true
        }
      },
      plugins: {
        legend: {
          display: false
        },
        datalabels: {
          display: true,
          color: 'white',
          anchor: 'end',
          align: 'right',
          offset: 0, 
        }
      }
    },
    plugins: [ChartDataLabels]
  };

  const ctx = document.getElementById('myChart').getContext('2d');
  if (window.myBarChart) {
    window.myBarChart.destroy();
  }
  window.myBarChart = new Chart(ctx, config);
}




</script>
<script>

let idUser;

  fetch('/get-user-info')
    .then(response => {
        if (response.ok) {
            return response.json();
        }

        if(response.status === 500 || response.status === 401 || response.status === 403) {
            console.log("není uživatel");

            window.location.href = '/login.html';
        }
        throw new Error('Network response was not ok.');
    })
    .then(data => {
        console.log('User Info:', data);

        const elements = document.querySelectorAll('.profileName');
        idUser = data.id;

        const email = data.email;
        const emailElements = document.querySelectorAll('.email');

        emailElements.forEach(element => {
            element.textContent = email;
        });


        elements.forEach(element => {
            element.textContent = data.username;
        });

        setInterval(checkUser, 300000); 

        fetch(`/profile-picture?userId=${idUser}`)
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Network response was not ok.');
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const profilePhoto = document.getElementById('profile_photo_preview');
            const profilePic = document.getElementById('profilePic');
            profilePic.src = url;
            profilePhoto.src = url;
        })
        .catch(error => {
            console.error('Error:', error);
        });

        fetch(`http://localhost:3000/dailyStats?userId=${idUser}`)
        .then(response => response.json())
        .then(data => {
          
            document.getElementById("gamesDaily").textContent = data.PocetOdehranychHer;
            document.getElementById("streakLDaily").textContent = data.LongestWinStreak;
            document.getElementById("streakCDaily").textContent = data.CurrentWinStreak;
            document.getElementById("winDaily").textContent = data.ProcentoVyhry.toFixed(2) + '%';
        })
        .catch(error => console.error('Error:', error));

        fetch(`http://localhost:3000/user-rapid-stats?user_id=${idUser}`)
        .then(response => response.json())
        .then(data => {
          
            document.getElementById('correctGuesses').textContent = data.total_correct_guesses;
            document.getElementById('gamesPlayed').textContent = data.games_played;
            document.getElementById('maxCorrectGuesses').textContent = data.max_correct_guesses;
            document.getElementById('avgCorrectGuesses').textContent = data.avg_correct_guesses.toFixed(2);
        })
        .catch(error => console.error('Error:', error));


        fetch(`http://localhost:3000/statistiky?userId=${idUser}`)
        .then(response => response.json())
        .then(data => {
          
            document.getElementById("games").textContent = data.PocetOdehranychHer;
            document.getElementById("streakL").textContent = data.LongestWinStreak;
            document.getElementById("streakC").textContent = data.CurrentWinStreak;
            document.getElementById("win").textContent = data.ProcentoVyhry.toFixed(2) + '%';
        })
        .catch(error => console.error('Error:', error));

        fetch(`http://localhost:3000/vyhry?userId=${idUser}`)
    .then(response => response.json())
    .then(data => {
      let chartData = Array(8).fill(0); 
        let labels = Array.from({length: 8}, (_, i) => (i + 1).toString()); 

        data.forEach(row => {
            const index = row.PokusUhodnuti - 1; 
            if (index >= 0 && index < chartData.length) {
                chartData[index] = row.PocetVyhranychHer;
            }
        });

        createChart(labels, chartData);

    })
    .catch(error => console.error('Error:', error));

    })
    .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
    });

    function loadFile(event) {
      var file = event.target.files[0]; // Get the file
      var formData = new FormData();
      formData.append('profilePhoto', file);

      fetch(`/upload-profile-picture?userId=${idUser}`, { // Endpoint to handle the upload
          method: 'POST',
          body: formData
      })
      .then(response => response.json())
      .then(data => {
          console.log('Success:', data);
      })
      .catch((error) => {
          console.error('Error:', error);
      });
    }

    function checkUser() {
        fetch('/get-user-info')
        .then(response => {
            if (response.ok) {
                return;
            }

            if (response.status === 500 || response.status === 401 || response.status === 403) {
                console.log("není uživatel");
                window.location.href = '/login.html';
            }
            throw new Error('Network response was not ok.');
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }
</script>
</body>
</html>
