<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friends</title>
  <link rel="shortcut icon" href="logo3.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

</head>
<style>
     .toastify-fade-in {
        animation: fade-in 0.5s ease-in-out;
    }
</style>
<body class="bg-gray-900 text-white">
<div class="min-h-screen bg-gray-900 text-white">

    <nav class="flex justify-between items-center p-4 border-b border-gray-800 sticky top-0 bg-gray-900">
        <a href="index.html" class="flex items-center hover:text-green-500">
            <img src="logo3.png" alt="NBA Logo" class="h-8 mr-2"> 
            <span class="text-xl font-semibold">NBA Guessing Game</span>
        </a>
        <div class="flex items-center">
            <button class="p-2">
                <a href="profile2.html" class="flex items-center hover:text-green-500">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.121A8.414 8.414 0 0112 20.414a8.414 8.414 0 016.879-3.293M12 4a4 4 0 110 8 4 4 0 010-8z" />
                  </svg>
                  <span class="text-xs font-semibold ml-2" id="user-info"></span>
              </a>
              
              </button>
              <a href="/logout" class="flex items-center ml-4 text-sm font-medium hover:text-red-500">
                <svg fill="currentColor" class="h-5 w-5" stroke="currentColor" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                  viewBox="0 0 320.002 320.002" xml:space="preserve">
                <g id="XMLID_6_">
                  <path id="XMLID_7_" d="M51.213,175.001h173.785c8.284,0,15-6.716,15-15c0-8.284-6.716-15-15-15H51.213l19.394-19.394
                    c5.858-5.858,5.858-15.355,0-21.213c-5.857-5.858-15.355-5.858-21.213,0L4.396,149.393c-0.351,0.351-0.683,0.719-0.997,1.103
                    c-0.137,0.167-0.256,0.344-0.385,0.515c-0.165,0.22-0.335,0.435-0.488,0.664c-0.14,0.209-0.261,0.426-0.389,0.64
                    c-0.123,0.206-0.252,0.407-0.365,0.619c-0.118,0.22-0.217,0.446-0.323,0.67c-0.104,0.219-0.213,0.435-0.306,0.659
                    c-0.09,0.219-0.164,0.442-0.243,0.664c-0.087,0.24-0.179,0.477-0.253,0.722c-0.067,0.222-0.116,0.447-0.172,0.672
                    c-0.063,0.249-0.133,0.497-0.183,0.751c-0.051,0.259-0.082,0.521-0.119,0.782c-0.032,0.223-0.075,0.443-0.097,0.669
                    c-0.048,0.484-0.073,0.971-0.074,1.457c0,0.007-0.001,0.015-0.001,0.022c0,0.007,0.001,0.015,0.001,0.022
                    c0.001,0.487,0.026,0.973,0.074,1.458c0.022,0.223,0.064,0.44,0.095,0.661c0.038,0.264,0.069,0.528,0.121,0.79
                    c0.05,0.252,0.119,0.496,0.182,0.743c0.057,0.227,0.107,0.456,0.175,0.681c0.073,0.241,0.164,0.474,0.248,0.71
                    c0.081,0.226,0.155,0.453,0.247,0.675c0.091,0.22,0.198,0.431,0.3,0.646c0.108,0.229,0.21,0.46,0.33,0.685
                    c0.11,0.205,0.235,0.4,0.354,0.599c0.131,0.221,0.256,0.444,0.4,0.659c0.146,0.219,0.309,0.424,0.466,0.635
                    c0.136,0.181,0.262,0.368,0.407,0.544c0.299,0.364,0.616,0.713,0.947,1.048c0.016,0.016,0.029,0.034,0.045,0.05l45,45.001
                    c2.93,2.929,6.768,4.394,10.607,4.394c3.838-0.001,7.678-1.465,10.606-4.393c5.858-5.858,5.858-15.355,0.001-21.213L51.213,175.001
                    z"/>
                  <path id="XMLID_8_" d="M305.002,25h-190c-8.284,0-15,6.716-15,15v60c0,8.284,6.716,15,15,15s15-6.716,15-15V55h160v210.001h-160
                    v-45.001c0-8.284-6.716-15-15-15s-15,6.716-15,15v60.001c0,8.284,6.716,15,15,15h190c8.284,0,15-6.716,15-15V40
                    C320.002,31.716,313.286,25,305.002,25z"/>
                </g>
                </svg>  
                <span class="ml-2">Logout</span>
              </a>

        </div>
    </nav>

  <div class="flex flex-col md:flex-row w-full md:w-3/4 m-auto">

    <div class="flex-1 p-8">
        <div class="mb-4">
            <a href="profile2.html" class="bg-gray-800 text-white py-2 px-4 rounded hover:bg-gray-600 flex items-center">
              <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Back to Profile
            </a>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Your Friends</h2>
            <div class="space-y-4" id="friendList">
              <!-- Dynamically list friends here -->
            </div>
            <h2 class="text-2xl font-bold mt-8 mb-4">Friend Requests</h2>
            <div class="space-y-4" id="requestList">
              <!-- Friend requests will be displayed here -->
            </div>
            <div class="mt-6">
              <button class="bg-green-700 text-white py-2 px-4 rounded hover:bg-green-800" onclick="togglePopup()">
                Add New Friend
              </button>
            </div>
        </div>
    </div>
    
  </div>

</div>

<div id="popup" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-gray-900 w-1/2 max-w-2xl h-96 rounded-lg p-8 relative text-center">
      <button onclick="togglePopup()" class="absolute top-0 right-0 mt-2 mr-2 text-white text-2xl font-bold">&times;</button>
      <h2 class="text-xl text-white mb-4">Send Friend Requests</h2>
      <input type="text" id="searchInput" onkeyup="filterUsers()" class="w-full bg-gray-800 text-white px-4 py-2 rounded-md mb-4" placeholder="Search users...">
      <div id="userList" class="overflow-y-auto text-white" style="max-height: calc(100% - 5rem);">
        <!-- Obsah uživatelů se sem načítá -->
      </div>
    </div>
  </div>
  
  
  
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.6.3/dist/umd/popper.min.js"></script>

<script>
    let idUser;
    
    fetch('/get-user-info')
    .then(response => {
        if (response.ok) {
            return response.json();
        }
    
        if(response.status === 401 || response.status === 403) {
            console.log("není uživatel");
            window.location.href = '/login.html';
        }
        throw new Error('Network response was not ok.');
    })
    .then(data => {
        console.log('User Info:', data);
        idUser = data.id;
        showFriendRequests();
        showFriends();
    
        document.getElementById('user-info').textContent = `${data.username}`;
    })
    .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
    });

    function togglePopup() {
        const popup = document.getElementById('popup');
        popup.classList.toggle('hidden');
        fetchUsers();
    }

    let users = [];

    function displayUsers() {
        let userList = document.getElementById("userList");
        userList.innerHTML = '';
        users.forEach(user => {
            let userDiv = document.createElement('div');
            userDiv.classList.add('flex', 'justify-between', 'items-center', 'mb-4');
            
            let userNameSpan = document.createElement('span');
            userNameSpan.textContent = user.Username;
            userNameSpan.classList.add('text-lg', 'font-bold');
            
            let addButton = document.createElement('button');
            addButton.textContent = 'Add Friend';
            addButton.classList.add('py-2', 'px-4', 'bg-blue-700', 'text-white', 'rounded', 'hover:bg-blue-800');
            addButton.onclick = function() { sendFriendRequest(user.ID); };
            
            userDiv.appendChild(userNameSpan);
            if (user.ID != idUser) {
                userDiv.appendChild(addButton);
            }
            
            userList.appendChild(userDiv);
        });
    }

    function filterUsers() {
        let input = document.getElementById('searchInput');
        let filter = input.value.toLowerCase();
        let userDivs = document.querySelectorAll('#userList > div');

        userDivs.forEach(userDiv => {
            let userName = userDiv.querySelector('span').textContent.toLowerCase();
            if (userName.includes(filter)) {
                userDiv.style.display = 'flex';
            } else {
                userDiv.style.display = 'none';
            }
        });
    }


    function fetchUsers() {
        fetch('/users')
        .then(response => response.json())
        .then(data => {
            users = data;
            displayUsers();
        })
    }

    function showFriends(){
        fetch(`/show-friends?user_id=${idUser}`)
        .then(response => response.json())
        .then(data => {
            let friendList = document.getElementById("friendList");
            friendList.innerHTML = '';
            data.forEach((friend, index) => {
                let friendDiv = document.createElement('div');
                friendDiv.classList.add('flex', 'items-center', 'mb-4'); // Základní třídy

                if (index > 0) { // Pro všechny kromě prvního prvku, přidáme horní okraj
                    friendDiv.classList.add('border-t', 'pt-4'); // Horní okraj a padding
                    friendDiv.style.borderColor = 'rgba(0,0,0,0.5)'; // Nastavení barvy okraje
                }

                let userNameSpan = document.createElement('span');
                userNameSpan.textContent = friend.Username;
                userNameSpan.classList.add('text-lg', 'font-bold', 'flex-grow');

                let buttonsDiv = document.createElement('div');

                let viewProfileButton = document.createElement('button');
                viewProfileButton.textContent = 'View Profile';
                viewProfileButton.classList.add('py-2', 'px-4', 'bg-blue-700', 'text-white', 'rounded', 'hover:bg-blue-800');
                viewProfileButton.onclick = function() { viewProfile(friend.id); };

                let deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('py-2', 'px-4', 'bg-red-700', 'text-white', 'rounded', 'hover:bg-red-800', 'ml-2');
                deleteButton.onclick = function() { deleteFriend(friend.id); };

                buttonsDiv.appendChild(viewProfileButton);
                buttonsDiv.appendChild(deleteButton);
                
                friendDiv.appendChild(userNameSpan);
                friendDiv.appendChild(buttonsDiv);

                friendList.appendChild(friendDiv);
            });
        })
    }


    function viewProfile(friendId) {
        window.location.href = `/friends_profile.html?user_id=${friendId}`;
    }


    function sendFriendRequest(targetUserId) {
        fetch('/send-friend-request', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sender_id: idUser, receiver_id: targetUserId })
        })
        .then(response => {
            if (response.ok) {
                showToastWithAnimation("Friend request sent!"); 
                togglePopup(); 
            } else {
            console.error('Error sending friend request');
            }
        })
        .catch(error => {
            console.error('There was a problem with the sendFriendRequest operation:', error);
        });
    }

    function showFriendRequests() {
    fetch(`/show-friend-requests?receiver_id=${idUser}`)
    .then(response => response.json())
    .then(data => {
        let requestList = document.getElementById("requestList");
        requestList.innerHTML = '';
        data.forEach((request, index) => {
            let requestDiv = document.createElement('div');
            requestDiv.classList.add('flex', 'items-center', 'mb-4');
            if (index > 0) { 
                requestDiv.style.borderTop = '1px solid rgba(0,0,0,0.5)';
                requestDiv.style.paddingTop = '16px'; 
            }
            
            let userNameSpan = document.createElement('span');
            userNameSpan.textContent = request.Username;
            userNameSpan.classList.add('text-lg', 'font-bold', 'flex-grow');
            
            let buttonContainer = document.createElement('div'); 
            buttonContainer.classList.add('flex');
            
            let acceptButton = document.createElement('button');
            acceptButton.textContent = 'Accept';
            acceptButton.classList.add('py-2', 'px-4', 'mr-2', 'bg-green-700', 'text-white', 'rounded', 'hover:bg-green-800');
            acceptButton.onclick = function() { acceptFriendRequest(request.id, idUser); };
            
            let rejectButton = document.createElement('button');
            rejectButton.textContent = 'Reject';
            rejectButton.classList.add('py-2', 'px-4', 'bg-red-700', 'text-white', 'rounded', 'hover:bg-red-800');
            rejectButton.onclick = function() { rejectFriendRequest(request.id, idUser); };
            
            buttonContainer.appendChild(acceptButton);
            buttonContainer.appendChild(rejectButton);
            
            requestDiv.appendChild(userNameSpan);
            requestDiv.appendChild(buttonContainer);
            
            requestList.appendChild(requestDiv);
        });
    })
}




    function deleteFriend(friendId) {
        fetch('/remove-friend', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: idUser, friend_id: friendId })
        })
        .then(response => {
            if (response.ok) {
                showToastWithAnimation("Friend deleted!");
                showFriends();
            } else {
            console.error('Error deleting friend');
            }
        })
        .catch(error => {
            console.error('There was a problem with the deleteFriend operation:', error);
        });
    }

    function rejectFriendRequest(senderId, receiverId){
        if (!senderId || !receiverId) {
            console.error('Sender and receiver IDs are required.');
            return;
        }

        const requestOptions = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            sender_id: senderId,
            receiver_id: receiverId
            })
        };

        
        fetch('/reject-friend-request', requestOptions)
            .then(response => {
                
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.text();
            })
            .then(data => {
            console.log(data); // Log the success message
            showToastWithAnimation("Friend request rejected!");
            showFriendRequests();
            showFriends();
            })
            .catch(error => {
            console.error('Error rejecting friend request:', error);
            });
    }

    function acceptFriendRequest(senderId, receiverId) {
        if (!senderId || !receiverId) {
            console.error('Sender and receiver IDs are required.');
            return;
        }

        const requestOptions = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            sender_id: senderId,
            receiver_id: receiverId
            })
        };

        
        fetch('/accept-friend-request', requestOptions)
            .then(response => {
                
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.text();
            })
            .then(data => {
            console.log(data); // Log the success message
            showToastWithAnimation("Friend request accepted!");
            showFriendRequests();
            showFriends();
            })
            .catch(error => {
            console.error('Error accepting friend request:', error);
            });
    }



    function showToastWithAnimation(text) {
        const toast = Toastify({
            text: text,
            duration: 3000,
            gravity: "top",
            position: "center",
            close: true,
            style: {
            background: "white",
            color: "#121827"
            },
            className: "toastify-example toastify-fade-in"
        });

        toast.showToast();
    }


    </script>
</body>
</html>
