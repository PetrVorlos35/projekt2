<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friends</title>
  <link rel="shortcut icon" href="logo3.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

</head>
<style>
     .toastify-fade-in {
        animation: fade-in 0.5s ease-in-out;
    }
    #logout{
      transform: rotate(-90deg);
    }
</style>
<body class="bg-gray-900 text-white">
<div class="min-h-screen bg-gray-900 text-white">

    <nav class="flex justify-between items-center p-4 border-b border-gray-800 sticky top-0 bg-gray-900">
        <a href="index.html" class="flex items-center hover:text-green-500">
            <img src="logo3.png" alt="NBA Logo" class="h-8 mr-2"> 
            <span class="text-xl font-semibold">NBA Guessing Game</span>
        </a>
        <div class="flex items-center">
            <button class="p-2">
                <a href="profile2.html" class="flex items-center hover:text-green-500">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="17.4219" height="18.0957"> 
                        <g> 
                            <rect height="18.0957" opacity="0" width="17.4219" x="0" y="0"/> 
                            <path d="M2.39258 18.0859L14.668 18.0859C16.2891 18.0859 17.0605 17.5977 17.0605 16.5234C17.0605 13.9648 13.8281 10.2637 8.53516 10.2637C3.23242 10.2637 0 13.9648 0 16.5234C0 17.5977 0.771484 18.0859 2.39258 18.0859ZM1.93359 16.6113C1.67969 16.6113 1.57227 16.543 1.57227 16.3379C1.57227 14.7266 4.05273 11.7383 8.53516 11.7383C13.0078 11.7383 15.4883 14.7266 15.4883 16.3379C15.4883 16.543 15.3906 16.6113 15.1367 16.6113ZM8.53516 9.04297C10.8594 9.04297 12.7539 6.98242 12.7539 4.46289C12.7539 1.96289 10.8691 0 8.53516 0C6.2207 0 4.31641 2.00195 4.31641 4.48242C4.31641 6.99219 6.21094 9.04297 8.53516 9.04297ZM8.53516 7.56836C7.10938 7.56836 5.88867 6.21094 5.88867 4.48242C5.88867 2.7832 7.08984 1.47461 8.53516 1.47461C9.99023 1.47461 11.1816 2.75391 11.1816 4.46289C11.1816 6.19141 9.9707 7.56836 8.53516 7.56836Z" fill="currentColor" fill-opacity="0.85"/>
                        </g> 
                     </svg>
                      
                      <span class="text-xs font-semibold ml-2" id="user-info"></span>
                  </a>
                  
                  </button>
                      <a href="/logout" class="flex items-center ml-4 text-sm font-medium hover:text-red-500">
                          <svg id="logout" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="17.6953" height="26.4746"> 
                            <g> 
                                <rect height="26.4746" opacity="0" width="17.6953" x="0" y="0"/> 
                                <path d="M17.334 10.7617L17.334 20.5078C17.334 22.5195 16.3086 23.5352 14.2676 23.5352L3.06641 23.5352C1.02539 23.5352 0 22.5195 0 20.5078L0 10.7617C0 8.75 1.02539 7.73438 3.06641 7.73438L6.00586 7.73438L6.00586 9.30664L3.08594 9.30664C2.10938 9.30664 1.57227 9.83398 1.57227 10.8496L1.57227 20.4199C1.57227 21.4355 2.10938 21.9629 3.08594 21.9629L14.2383 21.9629C15.2051 21.9629 15.7617 21.4355 15.7617 20.4199L15.7617 10.8496C15.7617 9.83398 15.2051 9.30664 14.2383 9.30664L11.3281 9.30664L11.3281 7.73438L14.2676 7.73438C16.3086 7.73438 17.334 8.75 17.334 10.7617Z" fill="currentColor" fill-opacity="0.85"/> 
                                <path d="M8.66211 15.8887C9.08203 15.8887 9.44336 15.5371 9.44336 15.127L9.44336 5.09766L9.38477 3.63281L10.0391 4.32617L11.5234 5.9082C11.6602 6.06445 11.8555 6.14258 12.0508 6.14258C12.4512 6.14258 12.7637 5.84961 12.7637 5.44922C12.7637 5.24414 12.6758 5.08789 12.5293 4.94141L9.22852 1.75781C9.0332 1.5625 8.86719 1.49414 8.66211 1.49414C8.4668 1.49414 8.30078 1.5625 8.0957 1.75781L4.79492 4.94141C4.64844 5.08789 4.57031 5.24414 4.57031 5.44922C4.57031 5.84961 4.86328 6.14258 5.27344 6.14258C5.45898 6.14258 5.67383 6.06445 5.81055 5.9082L7.28516 4.32617L7.94922 3.63281L7.89062 5.09766L7.89062 15.127C7.89062 15.5371 8.24219 15.8887 8.66211 15.8887Z" fill="currentColor" fill-opacity="0.85"/> 
                            </g> 
                          </svg>
                <span class="ml-2">Logout</span>
              </a>

        </div>
    </nav>

  <div class="flex flex-col md:flex-row w-full md:w-3/4 m-auto">

    <div class="flex-1 p-8">
        <div class="mb-4">
            <a href="profile2.html" class="bg-gray-800 text-white py-2 px-4 rounded hover:bg-gray-600 flex items-center">
                <svg class="mr-2" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="22.3047" height="17.9199"> 
                    <g>
                    <rect height="17.9199" opacity="0" width="22.3047" x="0" y="0"/>
                    <path d="M9.54102 17.9102C10.2051 17.9102 10.6836 17.4219 10.6836 16.7676L10.6836 13.0371L10.9668 13.0371C14.7559 13.0371 17.1387 13.9941 18.8477 17.1875C19.1895 17.8125 19.6387 17.9102 20.0488 17.9102C20.5664 17.9102 21.0547 17.4414 21.0547 16.6016C21.0547 9.38477 17.998 4.88281 10.9668 4.88281L10.6836 4.88281L10.6836 1.19141C10.6836 0.537109 10.2051 0 9.52148 0C9.04297 0 8.7207 0.205078 8.20312 0.693359L0.498047 7.90039C0.117188 8.26172 0 8.62305 0 8.95508C0 9.27734 0.126953 9.64844 0.498047 10L8.20312 17.2754C8.67188 17.7148 9.0625 17.9102 9.54102 17.9102ZM8.98438 15.8105C8.92578 15.8105 8.86719 15.7812 8.81836 15.7227L1.85547 9.14062C1.77734 9.0625 1.74805 9.01367 1.74805 8.95508C1.74805 8.89648 1.77734 8.83789 1.85547 8.76953L8.80859 2.09961C8.85742 2.06055 8.91602 2.02148 8.97461 2.02148C9.0625 2.02148 9.11133 2.08008 9.11133 2.1582L9.11133 6.03516C9.11133 6.25977 9.21875 6.35742 9.44336 6.35742L10.752 6.35742C17.4512 6.35742 19.4727 11.0059 19.668 15.6152C19.668 15.6934 19.6387 15.7227 19.5898 15.7227C19.5508 15.7227 19.5312 15.6934 19.502 15.625C18.3496 13.1738 15.3906 11.5625 10.752 11.5625L9.44336 11.5625C9.21875 11.5625 9.11133 11.6602 9.11133 11.8848L9.11133 15.6641C9.11133 15.752 9.0625 15.8105 8.98438 15.8105Z" fill="currentColor" fill-opacity="0.85"/> 
                    </g> 
                </svg>
              Back to Profile
            </a>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
            <div id="searchContainer" class="flex justify-between ">
                <h2 class="text-2xl font-bold mb-4">Your Friends</h2>
                <input type="text" id="searchBar" placeholder="Search friends..." class="full bg-gray-900 text-white px-4 py-2 rounded-md mb-4" onkeyup="showFriends()">
            </div>
            <div class="space-y-4" id="friendList">
              <!-- Dynamically list friends here -->
            </div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-md mt-4">
            <div id="searchRequestsContainer" class="flex justify-between">
                <h2 class="text-2xl font-bold mb-4">Friend Requests</h2>
                <input type="text" id="searchRequestsBar" placeholder="Search friend requests..." class="full bg-gray-900 text-white px-4 py-2 rounded-md mb-4" onkeyup="showFriendRequests()">
            </div>
            <div class="space-y-4" id="requestList">
              <!-- Friend requests will be displayed here -->
            </div>
            <div class="mt-6">
              <button class="bg-green-700 text-white py-2 px-4 rounded hover:bg-green-800" onclick="togglePopup()">
                Add New Friend
              </button>
            </div>
        </div>
    </div>
    
  </div>

</div>

<div id="popup" class="fixed inset-0 bg-gray-600 bg-opacity-50 justify-center items-center hidden">
    <div class="bg-gray-900 w-1/2 max-w-2xl h-96 rounded-lg p-8 m-auto top-1/4 relative text-center">
      <button onclick="togglePopup()" class="absolute top-0 right-0 mt-2 mr-2 text-white text-2xl font-bold">&times;</button>
      <h2 class="text-xl text-white mb-4">Send Friend Requests</h2>
      <input type="text" id="searchInput" onkeyup="filterUsers()" class="w-full bg-gray-800 text-white px-4 py-2 rounded-md mb-4" placeholder="Search users...">
      <div id="userList" class="overflow-y-auto text-white" style="max-height: calc(100% - 5rem);">
        <!-- Obsah uživatelů se sem načítá -->
      </div>
    </div>
  </div>
  
  
  
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.6.3/dist/umd/popper.min.js"></script>

<script>
    let idUser;
    
    fetch('/get-user-info')
    .then(response => {
        if (response.ok) {
            return response.json();
        }
    
        if(response.status === 401 || response.status === 403) {
            console.log("není uživatel");
            window.location.href = '/login.html';
        }
        throw new Error('Network response was not ok.');
    })
    .then(data => {
        console.log('User Info:', data);
        idUser = data.id;
        showFriendRequests();
        showFriends();
    
        document.getElementById('user-info').textContent = `${data.username}`;
    })
    .catch(error => {
        console.error('There has been a problem with your fetch operation:', error);
    });

    function togglePopup() {
        const popup = document.getElementById('popup');
        popup.classList.toggle('hidden');
        fetchUsers();
    }

    let users = [];

    function displayUsers() {
        let userList = document.getElementById("userList");
        userList.innerHTML = '';
        users.forEach(user => {
            let userDiv = document.createElement('div');
            userDiv.classList.add('flex', 'justify-between', 'items-center', 'mb-4');
            
            let userNameSpan = document.createElement('span');
            userNameSpan.textContent = user.Username;
            userNameSpan.classList.add('text-lg', 'font-bold');
            
            let addButton = document.createElement('button');
            addButton.textContent = 'Add Friend';
            addButton.classList.add('py-2', 'px-4', 'bg-blue-700', 'text-white', 'rounded', 'hover:bg-blue-800');
            addButton.onclick = function() { sendFriendRequest(user.ID); };
            
            userDiv.appendChild(userNameSpan);
            if (user.ID != idUser) {
                userDiv.appendChild(addButton);
            }
            
            userList.appendChild(userDiv);
        });
    }

    function filterUsers() {
        let input = document.getElementById('searchInput');
        let filter = input.value.toLowerCase();
        let userDivs = document.querySelectorAll('#userList > div');

        userDivs.forEach(userDiv => {
            let userName = userDiv.querySelector('span').textContent.toLowerCase();
            if (userName.includes(filter)) {
                userDiv.style.display = 'flex';
            } else {
                userDiv.style.display = 'none';
            }
        });
    }


    function fetchUsers() {
        fetch(`/users?user_id=${idUser}`)
        .then(response => response.json())
        .then(data => {
            users = data;
            displayUsers();
        })
        .catch(error => console.error('Error fetching users:', error));
    }

    function showFriends(){
    const searchInput = document.getElementById('searchBar').value.toLowerCase();
    fetch(`/show-friends?user_id=${idUser}`)
    .then(response => response.json())
    .then(data => {
        let friendList = document.getElementById("friendList");
        friendList.innerHTML = '';
        data.filter(friend => friend.Username.toLowerCase().includes(searchInput))
            .forEach((friend, index) => {
                let friendDiv = document.createElement('div');
                friendDiv.classList.add('flex', 'items-center', 'mb-4'); // Základní třídy

                if (index > 0) { // Pro všechny kromě prvního prvku, přidáme horní okraj
                    friendDiv.classList.add('border-t', 'pt-4'); // Horní okraj a padding
                    friendDiv.style.borderColor = 'rgba(0,0,0,0.5)'; // Nastavení barvy okraje
                }

                let userNameSpan = document.createElement('span');
                userNameSpan.textContent = friend.Username;
                userNameSpan.classList.add('text-lg', 'font-bold', 'flex-grow');

                let buttonsDiv = document.createElement('div');

                let viewProfileButton = document.createElement('button');
                viewProfileButton.textContent = 'View Profile';
                viewProfileButton.classList.add('py-2', 'px-4', 'bg-blue-700', 'text-white', 'rounded', 'hover:bg-blue-800');
                viewProfileButton.onclick = function() { viewProfile(friend.id); };

                let deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('py-2', 'px-4', 'bg-red-700', 'text-white', 'rounded', 'hover:bg-red-800', 'ml-2');
                deleteButton.onclick = function() { deleteFriend(friend.id); };

                buttonsDiv.appendChild(viewProfileButton);
                buttonsDiv.appendChild(deleteButton);
                
                friendDiv.appendChild(userNameSpan);
                friendDiv.appendChild(buttonsDiv);

                friendList.appendChild(friendDiv);
            });
    })
}



    function viewProfile(friendId) {
        window.location.href = `/friends_profile.html?user_id=${friendId}`;
    }


    function sendFriendRequest(targetUserId) {
        fetch('/send-friend-request', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sender_id: idUser, receiver_id: targetUserId })
        })
        .then(response => {
            if (response.ok) {
                showToastWithAnimation("Friend request sent!"); 
                togglePopup(); 
            } else {
            console.error('Error sending friend request');
            }
        })
        .catch(error => {
            console.error('There was a problem with the sendFriendRequest operation:', error);
        });
    }

    function showFriendRequests() {
        const searchInput = document.getElementById('searchRequestsBar').value.toLowerCase();
        fetch(`/show-friend-requests?receiver_id=${idUser}`)
        .then(response => response.json())
        .then(data => {
            let requestList = document.getElementById("requestList");
            requestList.innerHTML = '';
            data.filter(request => request.Username.toLowerCase().includes(searchInput))
                .forEach((request, index) => {
                    let requestDiv = document.createElement('div');
                    requestDiv.classList.add('flex', 'items-center', 'mb-4');
                    if (index > 0) { 
                        requestDiv.style.borderTop = '1px solid rgba(0,0,0,0.5)';
                        requestDiv.style.paddingTop = '16px'; 
                    }
                    
                    let userNameSpan = document.createElement('span');
                    userNameSpan.textContent = request.Username;
                    userNameSpan.classList.add('text-lg', 'font-bold', 'flex-grow');
                    
                    let buttonContainer = document.createElement('div'); 
                    buttonContainer.classList.add('flex');
                    
                    let acceptButton = document.createElement('button');
                    acceptButton.textContent = 'Accept';
                    acceptButton.classList.add('py-2', 'px-4', 'mr-2', 'bg-green-700', 'text-white', 'rounded', 'hover:bg-green-800');
                    acceptButton.onclick = function() { acceptFriendRequest(request.id, idUser); };
                    
                    let rejectButton = document.createElement('button');
                    rejectButton.textContent = 'Reject';
                    rejectButton.classList.add('py-2', 'px-4', 'bg-red-700', 'text-white', 'rounded', 'hover:bg-red-800');
                    rejectButton.onclick = function() { rejectFriendRequest(request.id, idUser); };
                    
                    buttonContainer.appendChild(acceptButton);
                    buttonContainer.appendChild(rejectButton);
                    
                    requestDiv.appendChild(userNameSpan);
                    requestDiv.appendChild(buttonContainer);
                    
                    requestList.appendChild(requestDiv);
                });
        })
    }





    function deleteFriend(friendId) {
        fetch('/remove-friend', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: idUser, friend_id: friendId })
        })
        .then(response => {
            if (response.ok) {
                showToastWithAnimation("Friend deleted!");
                showFriends();
            } else {
            console.error('Error deleting friend');
            }
        })
        .catch(error => {
            console.error('There was a problem with the deleteFriend operation:', error);
        });
    }

    function rejectFriendRequest(senderId, receiverId){
        if (!senderId || !receiverId) {
            console.error('Sender and receiver IDs are required.');
            return;
        }

        const requestOptions = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            sender_id: senderId,
            receiver_id: receiverId
            })
        };

        
        fetch('/reject-friend-request', requestOptions)
            .then(response => {
                
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.text();
            })
            .then(data => {
            console.log(data); // Log the success message
            showToastWithAnimation("Friend request rejected!");
            showFriendRequests();
            showFriends();
            })
            .catch(error => {
            console.error('Error rejecting friend request:', error);
            });
    }

    function acceptFriendRequest(senderId, receiverId) {
        if (!senderId || !receiverId) {
            console.error('Sender and receiver IDs are required.');
            return;
        }

        const requestOptions = {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            sender_id: senderId,
            receiver_id: receiverId
            })
        };

        
        fetch('/accept-friend-request', requestOptions)
            .then(response => {
                
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.text();
            })
            .then(data => {
            console.log(data); // Log the success message
            showToastWithAnimation("Friend request accepted!");
            showFriendRequests();
            showFriends();
            })
            .catch(error => {
            console.error('Error accepting friend request:', error);
            });
    }



    function showToastWithAnimation(text) {
        const toast = Toastify({
            text: text,
            duration: 3000,
            gravity: "top",
            position: "center",
            close: true,
            style: {
            background: "white",
            color: "#121827"
            },
            className: "toastify-example toastify-fade-in"
        });

        toast.showToast();
    }


    </script>
</body>
</html>
